version: "3.4"

x-healthcheck-defaults: &default-healthchecks
  interval: 30s
  timeout: 10s
  retries: 3

x-nx-volumes: &nx-volumes
  - ./:/usr/app
  - /usr/app/node_modules
  - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo-js:ro
  - ./mongodb/data:/data/db

services:
  db:
    image: mongo:4.4.1
    volumes: *nx-volumes
    ports:
      - 27017-27019:27017-27019
    restart: always

  # backend:
  #   image: ericvalens/gce:latest
  #   build:
  #     context: .
  #     args:
  #       PORT: 8080
  #       JAVA_OPTS: "-Ddebug -Xmx128m"
  #   volumes: *nx-volumes
  #   ports:
  #     - 8080:8080
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080"]
  #     <<: *default-healthchecks

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        PORT: 3333
    command: yarn serve:api
    volumes: *nx-volumes
    ports:
      - 3333:3333
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3333"]
      <<: *default-healthchecks

  app:
    build:
      context: .
      dockerfile: Dockerfile.app
      args:
        PORT: 4200
    command: yarn serve:web
    volumes: *nx-volumes
    ports:
      - 4200:4200
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4200"]
      <<: *default-healthchecks
